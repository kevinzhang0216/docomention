# TileLink学习手册

![20190731180538.png](https://i.loli.net/2019/07/31/5d4167f6df5bf53114.png)

## 1. 介绍

### 1.1 协议扩展级别

TileLink是芯片级的互联标准，允许多个主设备，支持一致性的存储器映射方式访问存储器和其他设备。
主要特点：
1. 为RISC-V 设计
2. 提供物理寻址，共享主存的的系统
3. 可以建立可拓展的，层次化的点对点网络
4. 提供一致性的访问
5. Cache 一致性的内存共享系统，兼容MOESI 的一致性协议
6. 可以保证无死锁
7. 乱序并发的操作，提高吞吐量
8. 使用解耦的通讯接口，可以插入寄存器优化时序
9. 总线宽度的透明自适应和突发传输序列的自动分割
10. 功耗优化的信号译码

### 1.2 文档内容
定义了三种不同量级的协议拓展，分别为：
1. TeilLink无缓存轻量级(Uncached Lightweight)： TL-UL。仅支持简单的单个字的存储器操作。
2. TeilLink无缓存重量级(Uncached Heavyweight): TL-UH。支持预处理（Hints），原子访问和突发访问，但不支持一致性的缓存访问。
3. TeilLink Cached （TL-C）。是支持异性的缓存模块
![20190731182135.png](https://i.loli.net/2019/07/31/5d416bb2414ff58665.png)

当不同协议进行通信时，使用相同的特性传输，或者使用转换模块。

## 2. 架构
### 2.1 网络拓扑
![20190731182916.png](https://i.loli.net/2019/07/31/5d416d801857746444.png)
![20190731182934.png](https://i.loli.net/2019/07/31/5d416d911d08c96444.png)
![20190731182951.png](https://i.loli.net/2019/07/31/5d416da1c829899664.png)
### 2.2 通道优先级
TileLink上定义了5个逻辑上独立的通道，代理通过它们传递信息。为了避免死锁定了信号的优先级。消息的传递是单向的。
在非TL-C中有两个通道，A和D。
![20190731183617.png](https://i.loli.net/2019/07/31/5d416f252e50612811.png)
![20190731183430.png](https://i.loli.net/2019/07/31/5d416eb945d3a43586.png)

各个通道传递消息的优先级顺序是A << B << C << D << E。

### 地址空间属性
操作目标地址段的属性限制了哪些类型的消息才可以在一个TileLink 网络中传播。一段地址空间的属性包括：TileLink 兼容层(conformance level)，存储一致性模型，是否可缓存(cacheability)，FIFO 顺序要求(ordering requirements)，是否可执行(executeability)， 特权层(privelege)以及服务质量保证(Quality-of-Service guarantees)。


## 3. 信号描述
1. 通道汇总
![20190731184442.png](https://i.loli.net/2019/07/31/5d41711d9c8d758001.png)
2. TeilLink信号类型汇总
![20190731184510.png](https://i.loli.net/2019/07/31/5d4171396d4f218739.png)
3. 链路参数
![20190731184529.png](https://i.loli.net/2019/07/31/5d41714c15cb541811.png)
   
### 时钟复位
TileLink 是一个同步总线协议。在TileLink 链路上的主接口和从接口都必须共享相同的时钟，复位和电源。然而，在拓扑结构里的不同链路可以是不同的时钟，复位和电源信号。
![20190731184901.png](https://i.loli.net/2019/07/31/5d41721fe825d81746.png)

### 复位
在将复位信号置0之前, 主端必须把a_valid, c_valid 和e_valid 这些信号置为低电平，而从端必须把b_valid 和d_valid 必须置为低电平。在复位信号低电平、时钟信号第一个上升沿之后，可以把有效信号（ valid）置为高电平。在复位信号置1 时，有效信号（valid）必须保持低电平至少100 个时钟周期。在复位期间，就绪、控制和数据信号可以取任意值。

![20190731185127.png](https://i.loli.net/2019/07/31/5d4172b2637dc99207.png)

### 电源与跨时钟
我们应该让这样的跨越行为小心地跟SoC 的其他部分协调一致，确保要跨越的一边复位或是下电时没有尚未处理的TileLink 请求。如果TileLink 消息一旦丢失或是重复，**将会导致整个TileLink 总线死锁**。

### 通道A
通道A 的传输方向是从主接口到从接口，携带请求消息发送到一个特定的地址。所有TileLink 兼容层都要强制使用这个通道。
![20190731185950.png](https://i.loli.net/2019/07/31/5d4174aa6262143408.png)

### 通道B（对于低层次层级可选）
传输方向是从接口道主接口。
![20190805220326.png](https://i.loli.net/2019/08/05/7UyX6ctZVijpuHf.png)

### 通道C（对于低层次层级可选）
传输方向是从主接口道从接口，对于B通道的响应。
![20190805220447.png](https://i.loli.net/2019/08/05/Htf9ZeVWu8Gi5EQ.png)

### 通道D (必须的)

![20190805220646.png](https://i.loli.net/2019/08/05/EgejTLMOiWhC4lf.png)

### 通道E（TL-C）
![20190805220759.png](https://i.loli.net/2019/08/05/M7Hf5WOjRwo9ihK.png)

## 4. 序列化
许多TileLink消息包含有效的数据负载，而根据消息和数据总线的大小，可能需要跨多个时钟周期(或beats)发送。多拍的信息则通常被称为簇发(burst)。没有数据载荷的TileLink消息总是在单拍中完成。TileLink禁止在一个通道中插入来自不同消息的任何数据。一旦一个簇发开始，发送方在簇发的最后一拍被接收方接收之前，都不得发送任何来自其他消息的任一拍数据。簇发的持续时间由通道的size字段决定。

### 流程控制规则
![20190805232444.png](https://i.loli.net/2019/08/05/ZiVWxFtUO37JsSP.png)

### 无死锁
通过管理接收端代理通过拉低ready来拒绝接受当前拍的信号。 其次通过定义有关tilelink中所通过的互联拓扑结构的规则。 

#### 规则中使用的定义
![20190805233900.png](https://i.loli.net/2019/08/05/er37gmtVOHRviQk.png)

### 请求响应消息排序
![20190805235934.png](https://i.loli.net/2019/08/06/Txfjdl2IQL5JUYv.png)


## 5. 操作与消息